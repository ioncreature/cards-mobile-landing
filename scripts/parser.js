/**
 * @author Alexander Marenin
 * @date November 2014
 */

var async = require( 'async' ),
    fs = require( 'fs' ),
    jsdom = require( 'jsdom' );

var vendorsJSON = "[{\"name\":\"Acer\",\"url\":\"http://www.sotovik.ru/catalog/phones/acer/\"},{\"name\":\"Airis\",\"url\":\"http://www.sotovik.ru/catalog/phones/airis/\"},{\"name\":\"AK Telecom\",\"url\":\"http://www.sotovik.ru/catalog/phones/ak_telecom/\"},{\"name\":\"Alphacell\",\"url\":\"http://www.sotovik.ru/catalog/phones/alphacell/\"},{\"name\":\"Amoi\",\"url\":\"http://www.sotovik.ru/catalog/phones/amoi/\"},{\"name\":\"Amoisonic\",\"url\":\"http://www.sotovik.ru/catalog/phones/amoisonic/\"},{\"name\":\"AnexTek\",\"url\":\"http://www.sotovik.ru/catalog/phones/anextek/\"},{\"name\":\"AnyDATA\",\"url\":\"http://www.sotovik.ru/catalog/phones/anydata/\"},{\"name\":\"Apple\",\"url\":\"http://www.sotovik.ru/catalog/phones/apple/\"},{\"name\":\"Arcoa\",\"url\":\"http://www.sotovik.ru/catalog/phones/arcoa/\"},{\"name\":\"Ares\",\"url\":\"http://www.sotovik.ru/catalog/phones/ares/\"},{\"name\":\"Arima\",\"url\":\"http://www.sotovik.ru/catalog/phones/arima/\"},{\"name\":\"ASUS\",\"url\":\"http://www.sotovik.ru/catalog/phones/asus/\"},{\"name\":\"Audiovox\",\"url\":\"http://www.sotovik.ru/catalog/phones/audiovox/\"},{\"name\":\"Axia\",\"url\":\"http://www.sotovik.ru/catalog/phones/axia/\"},{\"name\":\"BB-mobile\",\"url\":\"http://www.sotovik.ru/catalog/phones/bb-mobile/\"},{\"name\":\"BBK_Electronics\",\"url\":\"http://www.sotovik.ru/catalog/phones/bbk/\"},{\"name\":\"Belling\",\"url\":\"http://www.sotovik.ru/catalog/phones/belling/\"},{\"name\":\"BELLPERRE\",\"url\":\"http://www.sotovik.ru/catalog/phones/bellperre/\"},{\"name\":\"Bellwave\",\"url\":\"http://www.sotovik.ru/catalog/phones/bellwave/\"},{\"name\":\"Benefon\",\"url\":\"http://www.sotovik.ru/catalog/phones/benefon/\"},{\"name\":\"BenQ\",\"url\":\"http://www.sotovik.ru/catalog/phones/benq/\"},{\"name\":\"BenQ-Siemens\",\"url\":\"http://www.sotovik.ru/catalog/phones/benq_siemens/\"},{\"name\":\"Binatone\",\"url\":\"http://www.sotovik.ru/catalog/phones/binatone/\"},{\"name\":\"Bird\",\"url\":\"http://www.sotovik.ru/catalog/phones/bird/\"},{\"name\":\"BlackBerry\",\"url\":\"http://www.sotovik.ru/catalog/phones/blackberry/\"},{\"name\":\"Boost\",\"url\":\"http://www.sotovik.ru/catalog/phones/boost/\"},{\"name\":\"Bosch\",\"url\":\"http://www.sotovik.ru/catalog/phones/bosch/\"},{\"name\":\"CEC\",\"url\":\"http://www.sotovik.ru/catalog/phones/cec/\"},{\"name\":\"Cellvic\",\"url\":\"http://www.sotovik.ru/catalog/phones/cellvic/\"},{\"name\":\"CHEA\",\"url\":\"http://www.sotovik.ru/catalog/phones/chea/\"},{\"name\":\"COSUN\",\"url\":\"http://www.sotovik.ru/catalog/phones/cosun/\"},{\"name\":\"Curitel\",\"url\":\"http://www.sotovik.ru/catalog/phones/curitel/\"},{\"name\":\"CyberBell\",\"url\":\"http://www.sotovik.ru/catalog/phones/cyberbell/\"},{\"name\":\"Daewoo\",\"url\":\"http://www.sotovik.ru/catalog/phones/daewoo/\"},{\"name\":\"Dallab\",\"url\":\"http://www.sotovik.ru/catalog/phones/dallab/\"},{\"name\":\"Danger\",\"url\":\"http://www.sotovik.ru/catalog/phones/danger/\"},{\"name\":\"DBTel\",\"url\":\"http://www.sotovik.ru/catalog/phones/dbtel/\"},{\"name\":\"DELL\",\"url\":\"http://www.sotovik.ru/catalog/phones/dell/\"},{\"name\":\"Dnet\",\"url\":\"http://www.sotovik.ru/catalog/phones/dnet/\"},{\"name\":\"Dolphin\",\"url\":\"http://www.sotovik.ru/catalog/phones/dolphin/\"},{\"name\":\"Dopod\",\"url\":\"http://www.sotovik.ru/catalog/phones/dopod/\"},{\"name\":\"Dowtel\",\"url\":\"http://www.sotovik.ru/catalog/phones/dowtel/\"},{\"name\":\"Drin.it\",\"url\":\"http://www.sotovik.ru/catalog/phones/drinit/\"},{\"name\":\"E28\",\"url\":\"http://www.sotovik.ru/catalog/phones/e28/\"},{\"name\":\"Elitek\",\"url\":\"http://www.sotovik.ru/catalog/phones/elitek/\"},{\"name\":\"EMBLAZE\",\"url\":\"http://www.sotovik.ru/catalog/phones/emblaze/\"},{\"name\":\"EMGETON\",\"url\":\"http://www.sotovik.ru/catalog/phones/emgeton/\"},{\"name\":\"Emol\",\"url\":\"http://www.sotovik.ru/catalog/phones/emol/\"},{\"name\":\"eNOL\",\"url\":\"http://www.sotovik.ru/catalog/phones/enol/\"},{\"name\":\"Enteos\",\"url\":\"http://www.sotovik.ru/catalog/phones/enteos/\"},{\"name\":\"Ericsson\",\"url\":\"http://www.sotovik.ru/catalog/phones/ericsson/\"},{\"name\":\"Eten\",\"url\":\"http://www.sotovik.ru/catalog/phones/eten/\"},{\"name\":\"Europhone\",\"url\":\"http://www.sotovik.ru/catalog/phones/europhone/\"},{\"name\":\"EVO\",\"url\":\"http://www.sotovik.ru/catalog/phones/evo/\"},{\"name\":\"EXPLAY\",\"url\":\"http://www.sotovik.ru/catalog/phones/explay/\"},{\"name\":\"Ezio\",\"url\":\"http://www.sotovik.ru/catalog/phones/ezio/\"},{\"name\":\"Fly\",\"url\":\"http://www.sotovik.ru/catalog/phones/Fly/\"},{\"name\":\"G-Plus\",\"url\":\"http://www.sotovik.ru/catalog/phones/g-plus/\"},{\"name\":\"Garmin\",\"url\":\"http://www.sotovik.ru/catalog/phones/garmin/\"},{\"name\":\"Geo\",\"url\":\"http://www.sotovik.ru/catalog/phones/geo/\"},{\"name\":\"Giga\",\"url\":\"http://www.sotovik.ru/catalog/phones/giga/\"},{\"name\":\"Gigabyte\",\"url\":\"http://www.sotovik.ru/catalog/phones/gigabyte/\"},{\"name\":\"Gresso\",\"url\":\"http://www.sotovik.ru/catalog/phones/gresso/\"},{\"name\":\"GSL\",\"url\":\"http://www.sotovik.ru/catalog/phones/gsl/\"},{\"name\":\"GTran\",\"url\":\"http://www.sotovik.ru/catalog/phones/gtran/\"},{\"name\":\"Haier\",\"url\":\"http://www.sotovik.ru/catalog/phones/haier/\"},{\"name\":\"Handspring\",\"url\":\"http://www.sotovik.ru/catalog/phones/handspring/\"},{\"name\":\"Highscreen\",\"url\":\"http://www.sotovik.ru/catalog/phones/highscreen/\"},{\"name\":\"Hisense\",\"url\":\"http://www.sotovik.ru/catalog/phones/hisense/\"},{\"name\":\"Hitachi\",\"url\":\"http://www.sotovik.ru/catalog/phones/hitachi/\"},{\"name\":\"HP\",\"url\":\"http://www.sotovik.ru/catalog/phones/hp/\"},{\"name\":\"Huawei\",\"url\":\"http://www.sotovik.ru/catalog/phones/huawei/\"},{\"name\":\"Hyundai\",\"url\":\"http://www.sotovik.ru/catalog/phones/hyundai/\"},{\"name\":\"i-mate\",\"url\":\"http://www.sotovik.ru/catalog/phones/imate/\"},{\"name\":\"iKoMo\",\"url\":\"http://www.sotovik.ru/catalog/phones/ikomo/\"},{\"name\":\"Ilkone\",\"url\":\"http://www.sotovik.ru/catalog/phones/ilkone/\"},{\"name\":\"Innostream\",\"url\":\"http://www.sotovik.ru/catalog/phones/innostream/\"},{\"name\":\"iNQ\",\"url\":\"http://www.sotovik.ru/catalog/phones/inq/\"},{\"name\":\"iTravel\",\"url\":\"http://www.sotovik.ru/catalog/phones/itravel/\"},{\"name\":\"Jinga\",\"url\":\"http://www.sotovik.ru/catalog/phones/jinga/\"},{\"name\":\"JOA Telecom\",\"url\":\"http://www.sotovik.ru/catalog/phones/joa/\"},{\"name\":\"Just5\",\"url\":\"http://www.sotovik.ru/catalog/phones/just5/\"},{\"name\":\"Kejian\",\"url\":\"http://www.sotovik.ru/catalog/phones/kejian/\"},{\"name\":\"Kenned\",\"url\":\"http://www.sotovik.ru/catalog/phones/kenned/\"},{\"name\":\"Krome\",\"url\":\"http://www.sotovik.ru/catalog/phones/krome/\"},{\"name\":\"Kyocera\",\"url\":\"http://www.sotovik.ru/catalog/phones/kyocera/\"},{\"name\":\"Lenovo\",\"url\":\"http://www.sotovik.ru/catalog/phones/lenovo/\"},{\"name\":\"Maxon\",\"url\":\"http://www.sotovik.ru/catalog/phones/maxon/\"},{\"name\":\"Meizu\",\"url\":\"http://www.sotovik.ru/catalog/phones/meizu/\"},{\"name\":\"Micromax\",\"url\":\"http://www.sotovik.ru/catalog/phones/micromax/\"},{\"name\":\"Microsoft\",\"url\":\"http://www.sotovik.ru/catalog/phones/microsoft/\"},{\"name\":\"Mitac\",\"url\":\"http://www.sotovik.ru/catalog/phones/mitac/\"},{\"name\":\"Mitsubishi\",\"url\":\"http://www.sotovik.ru/catalog/phones/mitsubishi/\"},{\"name\":\"Mobiado\",\"url\":\"http://www.sotovik.ru/catalog/phones/mobiado/\"},{\"name\":\"Mobile shot\",\"url\":\"http://www.sotovik.ru/catalog/phones/mobileshot/\"},{\"name\":\"MODOTTEL\",\"url\":\"http://www.sotovik.ru/catalog/phones/modottel/\"},{\"name\":\"NEC\",\"url\":\"http://www.sotovik.ru/catalog/phones/nec/\"},{\"name\":\"Neonode\",\"url\":\"http://www.sotovik.ru/catalog/phones/neonode/\"},{\"name\":\"Newgen\",\"url\":\"http://www.sotovik.ru/catalog/phones/newgen/\"},{\"name\":\"O2\",\"url\":\"http://www.sotovik.ru/catalog/phones/o2/\"},{\"name\":\"Okwap\",\"url\":\"http://www.sotovik.ru/catalog/phones/okwap/\"},{\"name\":\"Onda\",\"url\":\"http://www.sotovik.ru/catalog/phones/onda/\"},{\"name\":\"Oppo\",\"url\":\"http://www.sotovik.ru/catalog/phones/oppo/\"},{\"name\":\"Palm\",\"url\":\"http://www.sotovik.ru/catalog/phones/palm/\"},{\"name\":\"Pantech\",\"url\":\"http://www.sotovik.ru/catalog/phones/pantech/\"},{\"name\":\"Phoenix\",\"url\":\"http://www.sotovik.ru/catalog/phones/phoenix/\"},{\"name\":\"Prestigio\",\"url\":\"http://www.sotovik.ru/catalog/phones/prestigio/\"},{\"name\":\"Pretec\",\"url\":\"http://www.sotovik.ru/catalog/phones/pretec/\"},{\"name\":\"QTek\",\"url\":\"http://www.sotovik.ru/catalog/phones/qtek/\"},{\"name\":\"Qualcomm\",\"url\":\"http://www.sotovik.ru/catalog/phones/qualcomm/\"},{\"name\":\"ROAD\",\"url\":\"http://www.sotovik.ru/catalog/phones/road/\"},{\"name\":\"Rolsen\",\"url\":\"http://www.sotovik.ru/catalog/phones/rolsen/\"},{\"name\":\"RoverPC\",\"url\":\"http://www.sotovik.ru/catalog/phones/rover/\"},{\"name\":\"RWT\",\"url\":\"http://www.sotovik.ru/catalog/phones/rwt/\"},{\"name\":\"Sagem\",\"url\":\"http://www.sotovik.ru/catalog/phones/sagem/\"},{\"name\":\"Sanyo\",\"url\":\"http://www.sotovik.ru/catalog/phones/sanyo/\"},{\"name\":\"Secufone\",\"url\":\"http://www.sotovik.ru/catalog/phones/secufone/\"},{\"name\":\"SED\",\"url\":\"http://www.sotovik.ru/catalog/phones/sed/\"},{\"name\":\"Sendo\",\"url\":\"http://www.sotovik.ru/catalog/phones/sendo/\"},{\"name\":\"Senseit\",\"url\":\"http://www.sotovik.ru/catalog/phones/senseit/\"},{\"name\":\"Sewon\",\"url\":\"http://www.sotovik.ru/catalog/phones/sewon/\"},{\"name\":\"Sharp\",\"url\":\"http://www.sotovik.ru/catalog/phones/sharp/\"},{\"name\":\"Siemens\",\"url\":\"http://www.sotovik.ru/catalog/phones/siemens/\"},{\"name\":\"Sierra\",\"url\":\"http://www.sotovik.ru/catalog/phones/sierra/\"},{\"name\":\"Sitronics\",\"url\":\"http://www.sotovik.ru/catalog/phones/sitronics/\"},{\"name\":\"SKY\",\"url\":\"http://www.sotovik.ru/catalog/phones/skyteletech/\"},{\"name\":\"SkyVox\",\"url\":\"http://www.sotovik.ru/catalog/phones/skyvox/\"},{\"name\":\"Sonim\",\"url\":\"http://www.sotovik.ru/catalog/phones/sonim/\"},{\"name\":\"Sony\",\"url\":\"http://www.sotovik.ru/catalog/phones/sony/\"},{\"name\":\"Soutec\",\"url\":\"http://www.sotovik.ru/catalog/phones/soutec/\"},{\"name\":\"Synertek\",\"url\":\"http://www.sotovik.ru/catalog/phones/synertek/\"},{\"name\":\"T-Mobile\",\"url\":\"http://www.sotovik.ru/catalog/phones/tmobile/\"},{\"name\":\"Tag Heuer\",\"url\":\"http://www.sotovik.ru/catalog/phones/tag-heuer/\"},{\"name\":\"TCL\",\"url\":\"http://www.sotovik.ru/catalog/phones/tcl/\"},{\"name\":\"Tel.Me\",\"url\":\"http://www.sotovik.ru/catalog/phones/telme/\"},{\"name\":\"Telit\",\"url\":\"http://www.sotovik.ru/catalog/phones/telit/\"},{\"name\":\"Telson\",\"url\":\"http://www.sotovik.ru/catalog/phones/telson/\"},{\"name\":\"TeXet\",\"url\":\"http://www.sotovik.ru/catalog/phones/texet/\"},{\"name\":\"Thuraya\",\"url\":\"http://www.sotovik.ru/catalog/phones/thuraya/\"},{\"name\":\"Toplux\",\"url\":\"http://www.sotovik.ru/catalog/phones/toplux/\"},{\"name\":\"Torson\",\"url\":\"http://www.sotovik.ru/catalog/phones/torson/\"},{\"name\":\"Toshiba\",\"url\":\"http://www.sotovik.ru/catalog/phones/toshiba/\"},{\"name\":\"Treo\",\"url\":\"http://www.sotovik.ru/catalog/phones/treo/\"},{\"name\":\"TSS\",\"url\":\"http://www.sotovik.ru/catalog/phones/tss/\"},{\"name\":\"Ubiquam\",\"url\":\"http://www.sotovik.ru/catalog/phones/ubiquam/\"},{\"name\":\"Versace\",\"url\":\"http://www.sotovik.ru/catalog/phones/versace/\"},{\"name\":\"Vertu\",\"url\":\"http://www.sotovik.ru/catalog/phones/vertu/\"},{\"name\":\"ViewSonic\",\"url\":\"http://www.sotovik.ru/catalog/phones/viewsonic/\"},{\"name\":\"VK_Mobile\",\"url\":\"http://www.sotovik.ru/catalog/phones/vkmobile/\"},{\"name\":\"Vodafone\",\"url\":\"http://www.sotovik.ru/catalog/phones/vodafone/\"},{\"name\":\"Voxtel\",\"url\":\"http://www.sotovik.ru/catalog/phones/voxtel/\"},{\"name\":\"Withus\",\"url\":\"http://www.sotovik.ru/catalog/phones/withus/\"},{\"name\":\"Wonu\",\"url\":\"http://www.sotovik.ru/catalog/phones/wonu/\"},{\"name\":\"X-cute\",\"url\":\"http://www.sotovik.ru/catalog/phones/xcute/\"},{\"name\":\"Xplore\",\"url\":\"http://www.sotovik.ru/catalog/phones/xplore/\"},{\"name\":\"XTE\",\"url\":\"http://www.sotovik.ru/catalog/phones/xte/\"},{\"name\":\"Xtreamer Mobile\",\"url\":\"http://www.sotovik.ru/catalog/phones/xtreamer-mobile/\"},{\"name\":\"Yakumo\",\"url\":\"http://www.sotovik.ru/catalog/phones/yakumo/\"},{\"name\":\"Yota\",\"url\":\"http://www.sotovik.ru/catalog/phones/yota/\"},{\"name\":\"Zakang\",\"url\":\"http://www.sotovik.ru/catalog/phones/zakang/\"},{\"name\":\"Zapp\",\"url\":\"http://www.sotovik.ru/catalog/phones/zapp/\"},{\"name\":\"Zetta\",\"url\":\"http://www.sotovik.ru/catalog/phones/zetta/\"},{\"name\":\"Zopo\",\"url\":\"http://www.sotovik.ru/catalog/phones/zopo/\"},{\"name\":\"ZTE\",\"url\":\"http://www.sotovik.ru/catalog/phones/zte/\"},{\"name\":\"Билайн\",\"url\":\"http://www.sotovik.ru/catalog/phones/beeline/\"},{\"name\":\"МегаФон\",\"url\":\"http://www.sotovik.ru/catalog/phones/megafon/\"},{\"name\":\"МТС\",\"url\":\"http://www.sotovik.ru/catalog/phones/mts/\"}]";

var tasks = JSON.parse( vendorsJSON ).map( function( vendor ){
    return function( cb ){
        console.log( vendor.name );
        jsdom.env(
            vendor.url,
            [],
            function( errors, window ){
                if ( errors )
                    console.log( errors );
                else {
                    var res = [],
                        phones = Array.prototype.slice.call( window.document.querySelectorAll( '.phones > li > strong > a' ) ).forEach( function( elem ){
                            res.push( elem.innerHTML );
                        });
                    cb( null, {
                        vendor: vendor.name,
                        models: res
                    });
                }
            }
        );
    };
});


var start = Date.now();
async.parallelLimit( tasks, 10, function( error, results ){
    console.log( 'Time elapsed ' + ((Date.now() - start) / 1000).toFixed( 1 ) + 's' );
    if ( error )
        console.log( error );
    else {
        fs.writeFileSync( 'phones', JSON.stringify(results), {encoding: 'utf8'} );
        console.log( 'Success!' );
        process.exit();
    }
});